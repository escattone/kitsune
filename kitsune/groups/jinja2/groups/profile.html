{% extends "groups/base.html" %}
{% set title = _('{group} | Groups')|f(group=profile.group.name) %}

{# Build breadcrumb trail #}
{% set crumbs = [(url('groups.list'), _('Groups'))] %}
{% set ancestors = profile.get_ancestors() %}
{% for ancestor in ancestors %}
  {% do crumbs.append((url('groups.profile', ancestor.slug), ancestor.group.name)) %}
{% endfor %}
{% do crumbs.append((None, profile.group.name)) %}

{% block side %}
  {# Avatar card #}
  <div class="card elevation-01 group-avatar-card">
    <div class="card--avatar-section">
      <img class="group-avatar" src="{{ group_avatar(profile) }}" alt="{{ profile.group.name }}" />
    </div>

    {% if user_can_edit %}
      <div class="card--actions">
        <a href="{{ url('groups.edit_avatar', profile.slug) }}" class="sumo-button secondary-button button-sm button-full-width">
          {{ _('Change Avatar') }}
        </a>
        {% if profile.avatar %}
          <a href="{{ url('groups.delete_avatar', profile.slug) }}" class="sumo-button link-button">
            {{ _('Delete Avatar') }}
          </a>
        {% endif %}
      </div>
    {% endif %}

    {# Quick stats #}
    <div class="group-stats">
      {% include "groups/partials/leader_count.html" with context %}
      {% include "groups/partials/member_count.html" with context %}
      {% if children %}
        <div class="stat-item">
          <span class="stat-value">{{ children|length }}</span>
          <span class="stat-label">{{ _('Subgroups') }}</span>
        </div>
      {% endif %}
    </div>
  </div>

  {# Hierarchy card #}
  {% if parent or children %}
    <div class="card elevation-01 group-hierarchy-card">
      <h3 class="card--title">{{ _('Hierarchy') }}</h3>
      {% if parent %}
        <div class="hierarchy-item">
          <label>{{ _('Parent:') }}</label>
          <a href="{{ url('groups.profile', parent.slug) }}">{{ parent.group.name }}</a>
        </div>
      {% endif %}
      {% if children %}
        <div class="hierarchy-item">
          <label>{{ _('Subgroups:') }}</label>
          <ul class="hierarchy-list">
            {% for child in children %}
              <li><a href="{{ url('groups.profile', child.slug) }}">{{ child.group.name }}</a></li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </div>
  {% endif %}

  {# Quick Actions card #}
  {% if user_can_moderate %}
    <div class="card elevation-01 group-actions-card">
      <h3 class="card--title">{{ _('Manage Group') }}</h3>

      <div class="quick-action">
        <input type="checkbox" id="toggle-add-users" class="action-toggle" />
        <label for="toggle-add-users" class="action-button">
          <span class="action-icon">+</span>
          {{ _('Add Users') }}
        </label>
        <div class="action-form">
          <form id="add-users-form" method="POST">
            {% csrf_token %}
            {{ member_form.users|safe }}
            <div class="action-buttons">
              <button type="submit" name="action" value="member"
                      hx-post="{{ url('groups.add_member', profile.slug) }}"
                      hx-swap="none"
                      class="sumo-button secondary-button button-sm">
                {{ _('Add to Members') }}
              </button>
              <button type="submit" name="action" value="leader"
                      hx-post="{{ url('groups.add_leader', profile.slug) }}"
                      hx-swap="none"
                      class="sumo-button secondary-button button-sm">
                {{ _('Add to Leaders') }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block content %}
  <article id="group-profile">
    {# Header section #}
    <header class="group-header">
      <div class="group-header--primary">
        <h1 class="sumo-page-heading">{{ profile.group.name }}</h1>
        <div class="group-header--meta">
          <span class="badge badge--visibility">
            {{ profile.get_visibility_display() }}
          </span>
          {% include "groups/partials/header_member_count.html" with context %}
        </div>
      </div>
      {% if user_can_edit %}
      <div class="group-header--actions">
        <a class="sumo-button secondary-button button-sm" href="{{ url('groups.edit', profile.slug) }}">
          {{ _('Edit Profile') }}
        </a>
        {% if user.is_staff and user.has_perm('groups.change_groupprofile') %}
          <a class="sumo-button secondary-button button-sm" href="{{ url('admin:groups_groupprofile_change', profile.id) }}">
            {{ _('Edit in admin') }}
          </a>
        {% endif %}
      </div>
      {% endif %}
    </header>

    {% if profile.information_html %}
    <div class="group-section" id="group-information">
      <div class="section-heading">
        <h2>{{ _('About this group') }}</h2>
      </div>
      <div class="group-info-content">
        {{ profile.information_html|safe }}
      </div>
    </div>
    {% endif %}

    {# Group Leaders section #}
    {% set is_leader = true %}
    {% include "groups/partials/leaders.html" with context %}

    {# Group Members section #}
    {% include "groups/partials/members.html" with context %}
  </article>
{% endblock %}
